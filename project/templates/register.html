{% extends "base.html" %}

{% block title %}OurTieba{% endblock %}

{% block head %}
    {{ super() }}
    <style>

        .form-signin {
            width: 100%;
            max-width: 330px;
            padding: 15px;
            margin: 0 auto;
        }

        .form-signin .checkbox {
            font-weight: 400;
        }

        .form-signin .form-control {
            position: relative;
            box-sizing: border-box;
            height: auto;
            padding: 10px;
            font-size: 16px;
        }

        .form-signin .form-control:focus {
            z-index: 2;
        }

        .form-signin input[type="email"] {
            margin-bottom: -1px;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }

        .form-signin input[type="password"] {
            margin-bottom: 10px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
		
		.register-form-field-hint{
			font-style: italic;
			color: #666666;
			font-size: 75%;
		}
    </style>
{% endblock %}

{% block page_content %}

    <h1>Register</h1>
    <hr>
	
	<iframe name="dummy" id="dummy" style="display: none;"></iframe>
	
    <form class="form-signin" action="{{ url_for('api.register_auth') }}" method="post" target="dummy">
        <img class="mb-4" src="{{ url_for("static", filename='ico/favicon.ico') }}" alt="" width="72"
             height="72">
		<h1 class="h3 mb-3 font-weight-normal">Join OurTieba</h1>
		<input type="text" id="uname" class="form-control" placeholder="Username" required autofocus>
		<p class="register-form-field-hint">Your username uniquely identifies you, and is used when you log in. You cannot change your username later.</p>
        <input type="text" id="nickname" class="form-control" placeholder="Nickname" required>
		<p class="register-form-field-hint">Your nickname is the name other people will see. You may change your nickname later.</p>
        <input type="password" id="password" class="form-control" placeholder="Password" required>
		<input type="password" id="repeat-password" class="form-control" placeholder="Repeat Password" required>
		<button class="btn btn-lg btn-primary btn-block" id="btn_submit" type="submit">Sign up</button>
    </form>
    <div id="username-err" class="alert alert-warning" style="display: none">
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
		$(document).ready(function () {
            $("#btn_submit").click(function () {
                let uname = $("#uname").val().trim();
				let nickname = $("#nickname").val().trim();
                let password = $("#password").val().trim();
				let rpassword= $("#repeat-password").val().trim();
				
				if (password !== rpassword){
					$("#username-err").html("Those passwords didn't match.");
					$("#username-err").show();
				}
				
                if (uname !== "" && nickname !== "" && password !== "") {
                    $.ajax({
                        url: '/api/auth/register',
                        type: 'post',
                        dataType: 'json',
                        data: {uname: uname, password: password, nickname: nickname},
                        success: function (response) {
                            let msg = "";
                            if (response.status) {
                                window.location = "/";
                            } else {
                                msg = error.msg;
                                $("#username-err").show();

                            }
                            $("#username-err").html(msg);

                        }
                    });
                }
            });
        });
	
        $("#btn-submit").on("click", () => {
            $.ajax({
                method: "post",
                url: "/api/auth/register",
                dataType: "json",
                data: {"uname": $("#uname").val(), "password": $("#password").val(), "nickname": $("#nickname").val()},
                success: function (data) {
                    if (data.status) {
                        window.location.href = "/";
                    } else {
                        $("#username-err").text(data.error.msg); // # = id, . = class
                    }
                }
            })
        })
    </script>
{% endblock %}
