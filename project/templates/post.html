{% extends "base.html" %}

{% block title %} Post {% endblock %}

{% block page_content %}
    <p style="font-size:50px">{{ data['post_info']['name'] }}</p>
    <div style="text-align: right; {% if data['num_page'] <= 1 %}display: none{% endif %}">
        Rank by:
        <a class="text-decoration-none" href="javascript:setParam('order', 'newest')">newest</a>
        <a class="text-decoration-none" href="javascript:setParam('order', 'like_count')">likes</a>
    </div>

    <h1>{{ data['post_info']['title'] }}</h1>

    <div class="blockquote-footer">{{ moment(data['post_info']['publish_time']).fromNow() }}</div>
    <div class="float-start">
        <a class="text-decoration-none"
           href="{{ url_for('abstract_user.get_personal_profile', Uid=data.post_info['Uid']) }}">
            <img src="{{ '/cdn/'+ data.post_info["avatar"] }}" width="32" height="32" class="rounded-circle">
        </a>
    </div>
    <div class="lead float-start">
        <a class="text-body text-decoration-none"
           href="{{ url_for('abstract_user.get_personal_profile', Uid=data.post_info['Uid']) }}">&nbsp;{{ data.post_info['owner'] }}</a>
    </div>
    <br>
    <br>
    <div class="btn-group">
        <button class="btn btn-outline-danger"><i class="bi bi-hand-thumbs-up"></i>{{ data.post_info['like_count'] }}
        </button>
        <button class="btn btn-outline-dark"><i class="bi bi-hand-thumbs-down"></i>{{ data.post_info['dislike_count'] }}
        </button>
    </div>
    {# Delete post trigger #}

    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deletePostModal">
        Delete Post
    </button>

    {# Delete post modal #}
    <div class="modal fade" id="deletePostModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Delete Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the post?
                    <br>
                    (All the comments are also deleted!)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('api.delete_post') }}" method="post">
                        <input type="hidden" name="Bid" value="{{ data.post_info['Bid'] }}">
                        <input type="hidden" name="Pid" value="{{ data.post_info['Pid'] }}">
                        <button class="btn btn-primary" type="submit">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Post content #}
    <hr>
    <p>{{ data['post_info']['content'] }}</p>

    {# Comments #}
    {% if data['comments']|length > 0 %}
        <hr>
        <div class="h2 lead">Comments:</div>
        <hr>
    {% endif %}

    {% for comment in data['comments'] %}
        <article class="post">
            <header>
                <div>
                    <div class="float-start">
                        <a class="text-body text-decoration-none"
                           href="{{ url_for('abstract_user.get_personal_profile', Uid=comment['Uid']) }}">
                            <img src="{{ '/cdn/'+ comment["user_avatar"] }}" width="32" height="32"
                                 class="rounded-circle">
                        </a>
                    </div>
                    <a class="text-body text-decoration-none"
                       href="{{ url_for('abstract_user.get_personal_profile', Uid=comment['Uid']) }}">
                        <div class="lead">&nbsp;{{ comment['publish_user'] }}</div>
                    </a>
                    <br>
                    <div class="blockquote-footer float-end">{{ moment(comment['publish_time']).fromNow() }}</div>
                    <div class="btn-group">
                        <form action="/api/like" method="post">
                            <input type="hidden" name="cid" value={{ comment['Cid'] }}>
                            <div class="btn btn{% if comment['liked_by_user'] %}{% else %}-outline{% endif %}-danger"
                                 type="submit"><i
                                    class="bi bi-hand-thumbs-up"></i>{{ comment['like_count'] }}</div>
                        </form>
                        <form action="/api/dislike" method="post">
                            <input type="hidden" name="cid" value={{ comment['Cid'] }}>
                            <div class="btn btn{% if comment['disliked_by_user'] %}{% else %}-outline{% endif %}-dark"
                                 type="submit"><i
                                    class="bi bi-hand-thumbs-down"></i>{{ comment['dislike_count'] }}</div>
                        </form>
                    </div>
                    <div>liked by {{ comment['like_count'] }} </div>
                    <div class="float-end">
                        <a class="text-decoration-none text-body"
                           href="{{ url_for('user.report', target='comment', id=comment.Cid) }}">
                            <div class="btn btn-outline-info">Report</div>
                        </a>
                    </div>
                </div>
            </header>
            <p class="body">{{ comment['content'] }}</p>
        </article>
        {% if not loop.last %}
            <hr>
        {% endif %}
    {% endfor %}
    <hr>
    {# Add comment #}
    <form action="{{ url_for('api.add_comment') }}" method="post">
        <div class="form-group row">
            <label for="content" class="col-sm-2 col-form-label">Add Comment</label>
            <div class="col-sm-10">
                <textarea class="form-control" name="content" id="content" rows="5" placeholder="Comment"></textarea>
            </div>
        </div>
        <br>
        <input type="hidden" name="Pid" value="{{ data['post_info']['Pid'] }}">
        <div class="form-group row">
            <div class="col-sm-10">
                <button type="submit" class="btn btn-primary">Comment</button>
            </div>
        </div>
    </form>
    <br>

    {# Pagination #}
    <nav {% if data['num_page'] <= 1 %}style="display: none"{% endif %}>
        <ul class="pagination justify-content-center">
            <li class="page-item {% if data['page'] == 1 %}disabled{% endif %}">
                <a class="page-link" href="javascript:setParam('page',{{ data['page'] - 1 }})"
                   tabindex="-1">Previous</a>
            </li>

            {% for i in range(1, 1 + data['num_page']) %}
                <li class="page-item{% if i == data['page'] %} active {% endif %}">
                    <a class="page-link" href="javascript:setParam('page',{{ i }})">{{ i }}</a>
                </li>
            {% endfor %}

            <li class="page-item {% if data['page'] == data['num_page'] %}disabled{% endif %}">
                <a class="page-link" href="javascript:setParam('page',{{ data['page'] + 1 }})">Next</a>
            </li>
        </ul>
    </nav>
{% endblock %}
