{% extends "base.html" %}

{% block title %} Boards {% endblock %}

{% block page_content %}
    <input id="init-data" type="hidden" value={{ session["Uid"] }} >
    {{ data }}
    <p style="font-size:50px">{{ data['board_info']['name'] }}</p>
    <br>
    <br>
    <div style="text-align: right">
        Sort by:
        <a href="javascript:setParam('order', 'latest_comment')">latest comment</a>
        <a href="javascript:setParam('order', 'newest')">newest</a>
        <a href="javascript:setParam('order', 'like_count')">likes</a>
    </div>
    <hr>
    {% for post in data['posts'] %}
        <article class="post">
            <header>
                <div>
                    <h3><a href="/post/{{ post['Pid'] }}" class="text-decoration-none">{{ post['title'] }}</a></h3>

                    <div class="blockquote-footer">{{ moment(post['publish_time']).fromNow() }}</div>

                    <div class="btn-group">
                        <form action="{{ url_for('api.like') }}" method="post">
                            <input type="hidden" name="target" value="post">
                            <input type="hidden" name="id" value={{ post['Cid'] }}>
                            <input type="hidden" name="like" value="{{ 0 if post['liked_by_user'] else 1 }}">
                            <button class="btn btn-sm btn{% if post['liked_by_user'] %}{% else %}-outline{% endif %}-danger"
                                    type="submit">
                                <i class="bi bi-hand-thumbs-up"></i>{{ post['like_count'] }}</button>
                        </form>
                        <form action="{{ url_for('api.dislike') }}" method="post">
                            <input type="hidden" name="target" value="post">
                            <input type="hidden" name="id" value={{ post['Cid'] }}>
                            <input type="hidden" name="like" value="{{ 0 if post['disliked_by_user'] else 1 }}">
                            <button class="btn btn-sm
                            btn{% if post['disliked_by_user'] %}{% else %}-outline{% endif %}-dark" type="submit">
                                <i class="bi bi-hand-thumbs-up"></i>{{ post['dislike_count'] }}</button>
                        </form>

                    </div>

                </div>
            </header>
            <p class="body">{{ post['summary'] }}</p>
        </article>
        {% if not loop.last %}
            <hr>
        {% endif %}
    {% endfor %}

    <hr>

    {# Add post #}
    <div>
        <div class="form-group row">
            <label class="col-sm-2 col-form-label" for="title">Title</label>
            <div class="col-sm-10">
                <input class="form-control" name="title" id="title" placeholder="Title" required>
            </div>
        </div>
        <br>
        <div class="form-group row">
            <label for="editor" class="col-sm-2 col-form-label">Content</label>
            <div class="col-sm-10">
                <!--<textarea class="form-control" name="content" id="content" rows="5" placeholder="Content"></textarea>-->
                <script id="editor" type="text/plain" style="width: 100%; height: 300px"></script>
            </div>
        </div>
        <br>
        <input type="hidden" id="Bid" value="{{ data['board_info']['Bid'] }}">
        <div class="form-group row">
            <div class="col-sm-10">
                <button class="btn btn-primary">Add Post</button>
            </div>
        </div>
    </div>
    <br>
    <script charset="UTF-8" src="/ueditor/ueditor.config.js"></script>
    <script charset="UTF-8" src="/ueditor/ueditor.all.min.js"></script>
    <script charset="UTF-8" src="/ueditor/lang/en/en.js"></script>
    <script>
        var Uid = $("#init-data").val();
        var ue = UE.getEditor('editor', {
            toolbars: [["simpleupload", "link", "|", "undo", "redo"]],
            enterTag: "br",  // user "br" instead of "p" to escape line
            imageScaleEnabled: false,
            elementPathEnabled : false,
            wordCount: !!Uid,
            maximumWords: 2000
        });
        ue.ready(() => {
            // get rid of popup messages
            $(".edui-editor-messageholder.edui-default").css({ "visibility": "hidden" });
            if (!Uid) {
                // disable title
                $("#title").attr("disabled", "disabled").attr("placeholder", "You must log in to create a post!");
                // disable editor
                ue.setDisabled();
                // add log in display info
                var view = $("iframe#ueditor_0").contents().find("body.view");
                var login_href = "/login?redirect=" + parent.location.href;
                view.html("Please <a href='" + login_href + "' target='_top'>log in</a> to create post.");
                // disable button
                $(".btn-primary").attr("disabled", "disabled");
            }
        })

        $(".btn-primary").on("click", () => {
            // check login status
            if (!Uid) {
                alert("Please log in to create a post!");
                location.href = "/login";
                return
            }
            // check title not null
            var title = $("#title").val();
            if (!title) {
                alert("You must enter a title!");
                return
            }
            // if everything ok, send request
            $.ajax({
                method: "POST",
                url: "/api/post/add",
                dataType: "json",
                data: {
                    Bid: $("#Bid").val(),
                    title: title,
                    content: ue.getContent()
                },
                success: data => {
                    if (data.status !== 1) {
                        alert("Create post failed. Please try again!")
                    }
                    location.reload();
                }
            })
        })
    </script>

    {# Pagination #}
    <nav {% if data['num_page'] <= 1 %}style="display: none"{% endif %}>
        <ul class="pagination justify-content-center">
            <li class="page-item {% if data['page'] == 1 %}disabled{% endif %}">
                <a class="page-link" href="javascript:setParam('page',{{ data['page'] - 1 }})"
                   tabindex="-1">Previous</a>
            </li>

            {% for i in range(1, 1 + data['num_page']) %}
                <li class="page-item{% if i == data['page'] %} active {% endif %}">
                    <a class="page-link" href="javascript:setParam('page',{{ i }})">{{ i }}</a>
                </li>
            {% endfor %}

            <li class="page-item {% if data['page'] == data['num_page'] %}disabled{% endif %}">
                <a class="page-link" href="javascript:setParam('page',{{ data['page'] + 1 }})">Next</a>
            </li>
        </ul>
    </nav>


{% endblock %}
